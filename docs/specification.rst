Specification of a mex_gene_archive file
========================================

A mex_gene_archive tar file contains 4 files:

- ${path}/metadata.tsv
- ${path}/barcodes.tsv
- ${path}/features.tsv
- ${path}/${matrix}.mtx

To improve reproducibility the file time stamps for all of the files included in the
archive are set to the UNIX time stamp 0, which is 1970-01-01 at 00:00 UTC.


Specification for a mex_gene_archive generated with STARsolo
------------------------------------------------------------
  
The ${path} varies as it is the path the aligner used when writing out
the matrix market exchange file. Since the are frequently multiple versions
of the matrix files they are usually written to separate directories.

One design goal was to avoid making any uncessary changes to the
aligner output.

The STAR aligner supports several different gene counting strategies and provides
optional EM assignment of multi reads, and lastly there is a choice between
raw unfiltered matrices and count matrices filtered by various various methods.

Taken together that leads to possible STAR paths which represent different gene
counting strategies.

The first directory name is one of the following:

Gene
   For a UMI to count as belonging to a gene it must fully overlap the exons
   in the gene model.
   
GeneFull
   A UMI will count as belonging to a gene if any of it overlaps the 
   the gene model including both introns and exons.
   
GeneFull_Ex50pAS
   A UMI will count as belonging to a gene if at is in the gene model and at
   least 50% of the read overlaps an exon in the gene model.

SJ
  Contains counts for unannotated and novel splice junctions. In the case
  of splice junctions the features.tsv is an extended tsv file containing:
  contig, start, end, strand, intron_motif, annotated, unique, multi,
  and overhang columns.

The second directory name is one of the following and influenced by
`Cell filtering`_

raw
  This is an unfiltered raw matrix
  
filtered
  The matrix has been filtered, in ENCODES case, with the EmptyDrops method.
  

The final component of the path is the 4 files that make up the matrix
definition.  Three file names are hardcoded, but the last the matrix
name is influenced by the `Multi-gene reads`_ argument of STAR gand can
be one of:

matrix.mtx
  the matrix contains only uniquely mapping reads

UniqueAndMult-EM.mtx
  the matrix contains counts generated by using the EM algorithm to
  assign multi-mapping reads.

UniqueAndMult-Rescue.mtx
  This is unused in ENCODE but assigns multi-gene UMIs to their gene
  proportionally to the sum of the number of unique gene UMIs.


The matrix market file format is defined at `Matrix Market format`_ though
functions are available in many libraries to read the files.

mex_gene_archive also provides :ref:`mex_gene_archive.reader.read_mex_archive` to read an
archive file into 4 dictionaries and
:ref:`mex_gene_archive.reader.read_mex_archive_as_anndata` to load the matrix into an
AnnData structure.

Both functions can be used with either local filenames or objects
providing a file object like interface for reading remote objects.

metadata.tsv
------------

The metadata.tsv file is a simple tsv file containing a list of name
value pairs, and the metadata.tsv file should always be first in the archive
to make it easier to decide if one wants to download the full archive file.

type
   the fixed string MexGeneArchive_v1 in case there is ever a need to change
   the file format.
   
output_type
   Corresponds to the ENCODE portal output type for this file which is one of the following
   - sparse gene count matrix of all reads
   - sparse gene count matrix of unique reads
   - unfiltered sparse gene count matrix of all reads
   - unfiltered sparse gene count matrix of unique reads
   - unfiltered sparse splice junction count matrix of unique reads

software_version
   Either the version of the aligner used for the raw matrices, or the
   version of mex_gene_archive used for merged matrices.

arguments
   Command line arguments used for the aligner.

experiment_accession
   An accession ID for the experiment this file was derived from

description
   A free form text description of the file, which is usually the experiment
   description

library_accession
    An accession ID for the specific library this matrix was generated for
    in case there are some form of replicate associated with the experiment.

${filename}
    And finally a list of the full path name to the three included matrix
    market exchange files with the values ${hash algorithm}:${hash}.
    Currently the md5sum hash algorithm is implemented.

.. _`Matrix Market format`: https://math.nist.gov/MatrixMarket/formats.html
.. _`Multi-gene reads`: https://github.com/alexdobin/STAR/blob/master/docs/STARsolo.md#multi-gene-reads  
.. _`Cell filtering`: https://github.com/alexdobin/STAR/blob/master/docs/STARsolo.md#cell-filtering-calling
